{% extends "layout.html" %}

{% block body %}
    <div id="chatScreenWrapper" class="row justify-content-center" style="min-width: 350px;">
      <div class="col-3 overflow-auto border mt-3" style="min-height: 500px; max-height: 500px; word-wrap: break-word;">
          <ul id="chatList" class="list-group mt-3">
              <div class="row justify-content-center mb-3">
                  <input id="searchUser" class="col-10 py-1 mr-2" placeholder="Search friends" aria-label="Search">
                  <hr class="mb-0" style="width: 100%; height: 1px; background-color: light-grey;">
              </div>
              {% if friends %}
                {% for friend in friends %}
                    {% if friend['id'] != session['userid'] %}
                        {% if friend['id'] == selectedUserID %}
                            <li class="user-list list-group-item active py-1" style="display: block;">
                                <a href="{{url_for('showMessages', userid=session['userid'], receiverid=friend['id'])}}" class="text-white">
                                    {{friend['name']}}
                                </a>
                            </li>
                        {% else %}
                            <li class="user-list list-group-item py-1" style="display: block;">
                                <a href="{{url_for('showMessages', userid=session['userid'], receiverid=friend['id'])}}" class="text-dark">
                                    {{friend['name']}}
                                </a>
                            </li>
                        {% endif %}
                    {% endif %}
                {% endfor %}
              {% else %}
                <p class="mt-3">
                    No friends. Let's send a friend request first!
                </p>
              {% endif %}
          </ul>
      </div>
      <div id="chatListWrapper" class="col-8 overflow-auto border mt-3" style="min-height: 500px; max-height: 500px; word-wrap: break-word;">
          {% if chatScreen %}
              {% if messages %}
                  <ul id="chatScreen" class="list-group mt-3">
                    {% for message in messages %}
                      {% if message['sender_id'] == session['userid'] %}
                        <li class="list-group-item rounded-lg active align-self-end py-1 mb-2" style="max-width: 50%;">
                          {{message['message']}}
                        </li>
                      {% else %}
                        <div class="d-flex align-items-start">
                            <img src="{{receiver_image}}" class="rounded-circle mr-1" style="height: 33px; width: 33px;">
                            <li class="list-group-item rounded-lg align-self-start py-1 mb-2" style="max-width: 45%;">
                              {{message['message']}}
                            </li>
                        </div>
                      {% endif %}
                    {% endfor %}
                  </ul>
              {% else %}
                  <p id="initialMsg" class="mt-3 text-center">
                      This is the beginning of chat. Let's send a message to start chatting!
                  </p>
              {% endif %}
        {% else %}
            <p class="mt-3 text-center">
                Please select the person to chat with from the left.
            </p>
        {% endif %}
      </div>
      <div class="col-8 mt-3 mb-3">
          <div class="row justify-content-between">
            <input id="message" class="col-9 align-self-start py-1 ml-2" type="text">
            <button class="col-2 align-self-end btn-primary rounded-lg py-1 mr-2" type="submit" onclick="sendMsg()">Send</button>
          </div>
      </div>
    </div>

    <script>
        const socket = io('');

        socket.on('showMsg', function(data) {
            var initialMsg = document.getElementById("initialMsg");
            if (typeof(initialMsg) != 'undefined' && initialMsg != null) {
                document.getElementById("initialMsg").style.display = "none";
                var msgListWrapper = document.createElement('ul');
                msgListWrapper.setAttribute("id", "chatScreen");
                msgListWrapper.setAttribute("class", "list-group mt-3");
                document.getElementById("chatListWrapper").appendChild(msgListWrapper);
            }
            if (data['sender_id'] == {{session['userid']}}) {
                var msgWrapper = document.createElement('li');
                msgWrapper.setAttribute("class", "list-group-item rounded-lg active align-self-end py-1 mb-2");
                msgWrapper.setAttribute("style", "max-width: 50%;");
                msgWrapper.innerText = data['message'];
                document.getElementById("chatScreen").appendChild(msgWrapper);
            } else {
                var msgWrapper = document.createElement('li');
                msgWrapper.setAttribute("class", "list-group-item rounded-lg align-self-start py-1 mb-2");
                msgWrapper.setAttribute("style", "max-width: 50%;");
                msgWrapper.innerText = data['message'];
                document.getElementById("chatScreen").appendChild(msgWrapper);
            }
        });

        function sendMsg() {
          var d = new Date();
          var timestamp = d.getFullYear().toString()+"/"+
                          ((d.getMonth()+1).toString().length==2?(d.getMonth()+1).toString():"0"+(d.getMonth()+1).toString())+"/"+
                          (d.getDate().toString().length==2?d.getDate().toString():"0"+d.getDate().toString())+" "+
                          (d.getHours().toString().length==2?d.getHours().toString():"0"+d.getHours().toString())+":"+
                          ((parseInt(d.getMinutes())).toString().length==2?(parseInt(d.getMinutes())).toString():"0"+(parseInt(d.getMinutes())).toString())+":"+
                          ((parseInt(d.getSeconds())).toString().length==2?(parseInt(d.getSeconds())).toString():"0"+(parseInt(d.getSeconds())).toString());
          // If the room already exists
          if ({{messagesDict|tojson}} != null) {
              socket.emit('reflectMsg',
                          {'room_id': {{messagesDict|tojson}}[0]['room_id'],
                           'sender_id': {{session['userid']}},
                           'message': document.getElementById("message").value,
                           'timestamp': timestamp
                          });
          } else {
              socket.emit('reflectMsg',
                          {'sender_id': {{session['userid']}},
                           'receiver_id': window.location.href.split('messages/')[1].slice(0, -1),
                           'message': document.getElementById("message").value,
                           'timestamp': timestamp
                          });
          }
          document.getElementById('message').value = ''
        }

        // User search function
        search = () => {
          var filteredUserList = [];
          var inputText = document.getElementById("searchUser").value;
          var userList = document.getElementsByClassName("user-list");

          // Check if inputText contains any character other than spaces
          if (/\S/.test(inputText)) {
            for (let i=0; i<userList.length; i++) {
                if (userList[i].innerText.indexOf(inputText) != -1) {
                    filteredUserList.push(userList[i]);
                }
            }
            if (filteredUserList.length == 0) {
                for (let i=0; i<userList.length; i++) {
                    userList[i].setAttribute("style", "display: none;");
                }
            } else {
                for (let i=0; i<userList.length; i++) {
                  if (!filteredUserList.includes(userList[i])) {
                     userList[i].setAttribute("style", "display: none;");
                  }
                }
            }
          } else {
            for (let i=0; i<userList.length; i++) {
                userList[i].setAttribute("style", "display: block;");
            }
          }
        };

        // Whenever user inputs something in search box
        $('#searchUser').on('input', search);
    </script>
{% endblock %}
